### **Delayed Notifier**

**Delayed Notifier** — это асинхронный сервис для отправки отложенных уведомлений в Telegram. Он предоставляет HTTP API для создания, проверки статуса и удаления уведомлений, а фоновые задачи обеспечивают их надёжную и своевременную доставку.

-----

### **Содержание**

1.  О проекте
2.  Архитектура
3.  Технологии
4.  Начало работы
      * Клонирование репозитория
      * Запуск зависимостей
      * Настройка
      * Запуск приложения
5.  API
      * Создание уведомления
      * Получение статуса
      * Удаление уведомления
6.  Структура проекта
7.  Тестирование

-----

### **О проекте**

Сервис **Delayed Notifier** был создан для демонстрации асинхронной обработки задач в Go. Он использует модель микросервисов и многослойную архитектуру, чтобы разделить ответственность между компонентами:

  * **HTTP-сервер** принимает запросы и немедленно отвечает.
  * **Брокер сообщений (RabbitMQ)** надёжно хранит задачи в очереди.
  * **Воркеры** в фоновом режиме обрабатывают задачи и отправляют уведомления.

Такой подход обеспечивает высокую отказоустойчивость: если воркеры временно недоступны, сообщения остаются в очереди и будут обработаны позже.

-----

### **Архитектура**

  * **HTTP-сервер:** Написан на Go и использует роутер `chi`. Он принимает запросы от пользователей, выполняет валидацию и передает их в сервисный слой.
  * **Сервисный слой:** Содержит бизнес-логику. Он взаимодействует с **хранилищем** для сохранения данных и с **брокером** для постановки задач в очередь.
  * **Хранилище:** Обеспечивает персистентность данных с помощью **PostgreSQL** (для долговременного хранения) и **Redis** (для быстрого доступа к статусам).
  * **Брокер сообщений (RabbitMQ):** Является посредником между HTTP-сервером и воркерами. Гарантирует, что каждое сообщение будет доставлено и обработано.
  * **Воркеры:** Это фоновые процессы, которые слушают очередь RabbitMQ. Когда приходит сообщение, воркер получает данные из хранилища, проверяет время и отправляет уведомление через **Telegram API**.
  * **Клиент (UI):** Простой HTML/CSS/JS-интерфейс, позволяющий взаимодействовать с API сервиса.

-----

### **Технологии**

  * **Язык программирования:** Go
  * **Фреймворк:** [chi](https://github.com/go-chi/chi) — роутер для HTTP-сервера
  * **База данных:** [PostgreSQL](https://www.postgresql.org/) — для надёжного хранения данных
  * **Кэш:** [Redis](https://redis.io/) — для быстрого доступа к статусам уведомлений
  * **Брокер сообщений:** [RabbitMQ](https://www.rabbitmq.com/) — для асинхронной обработки задач
  * **Клиент Telegram API:** [go-telegram-bot-api](https://github.com/go-telegram-bot-api/telegram-bot-api) — для отправки сообщений
  * **Управление зависимостями:** Docker, `docker-compose`

-----

### **Начало работы**

#### Клонирование репозитория

```bash
git clone https://github.com/veylin2175/DelayedNotifier
cd DelayedNotifier
```

#### Запуск зависимостей

Используйте `docker-compose`, чтобы запустить Redis и RabbitMQ.

```bash
docker-compose up -d
```

#### Настройка

1.  Создайте файл `config/local.yml` на основе `config/local.example.yml`.
2.  Вставьте токен своего Telegram-бота в поле `tg_token`.
3.  Вставьте пароль от своего PostgreSQL в поле `password`.
4.  Создайте переменную окружения `CONFIG_PATH=./config/local.yml` либо используйте флаги при запуске приложения.

#### Запуск приложения

```bash
go run cmd/delayedNotifier/main.go
```

Сервер будет запущен по адресу, указанному в конфигурации (по умолчанию `localhost:8099`).

-----

### **API**

#### Создание уведомления

Создает новое уведомление и ставит задачу в очередь.

**`POST /notify`**

**Тело запроса:**

```json
{
  "recipient_id": 123456789,
  "date": "2025-08-09 23:55:00",
  "text": "Привет! Это отложенное сообщение."
}
```

**Ответ:**

```json
{
  "status": "OK",
  "notification_id": 1
}
```

-----

#### Получение статуса

Получает текущий статус уведомления.

**`GET /notify/{id}`**

**Пример:** `GET /notify/1`

**Ответ:**

```json
{
  "status": "OK",
  "notification_status": "pending"
}
```

-----

#### Удаление уведомления

Удаляет уведомление по ID.

**`DELETE /notify/{id}`**

**Пример:** `DELETE /notify/1`

**Ответ:**

```json
{
  "status": "OK"
}
```

-----

### **Структура проекта**

```bash
.
├── cmd/
│   └── delayedNotifier/
│       └── main.go       # Точка входа в приложение
├── config/
│   └── local.yml         # Файл с настройками
├── internal/
│   ├── config/           # Парсинг конфигов
│   ├── rabbitMQ/         # Логика работы с RabbitMQ
│   ├── http-server/      # Обработчики HTTP-запросов
│   ├── lib/              # Логгеры и работа с API
│   ├── models/           # Модели данных
│   ├── telegram/         # Клиент для Telegram API
│   ├── service/          # Бизнес-логика (сервисный слой)
│   ├── storage/          # Логика взаимодействия с БД и Redis
│   └── worker/           # Асинхронные обработчики задач
├── static/
│   ├── index.html        # UI
│   ├── style.css
│   └── script.js
├── docker-compose.yml    # Контейнеризация RabbitMQ и Redis
└── go.mod
```

-----

### **Тестирование**

Проект покрыт юнит-тестами для каждого компонента. Для запуска тестов выполните:

```bash
go test ./...
```
